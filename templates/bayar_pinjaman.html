{% extends "base_app.html" %}
{% block title %}Pembayaran Pinjaman - Koperasi{% endblock %}

{% block content %}
  <div class="mb-6">
    <h1 class="text-2xl font-extrabold text-white drop-shadow">Pembayaran Cicilan Pinjaman</h1>
    <p class="text-white/80 mt-1">Pinjaman #{{ pinjaman.id }}</p>
  </div>

  <!-- INFO PINJAMAN -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <!-- Card 1: Status Pinjaman -->
    <div class="rounded-2xl bg-white/90 backdrop-blur border border-white/30 shadow-lg p-6">
      <h3 class="text-sm uppercase font-bold text-slate-600 mb-3">Status Pinjaman</h3>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Status:</span>
          <span class="px-3 py-1 rounded-full text-xs font-bold {% if loan_status.status == 'disbursed' %}bg-green-100 text-green-800{% elif loan_status.status == 'lunas' %}bg-indigo-100 text-indigo-800{% else %}bg-gray-100 text-gray-800{% endif %}">
            {% if loan_status.status == "disbursed" %}âœ… Sudah Dicairkan
            {% elif loan_status.status == "lunas" %}ğŸ Lunas
            {% else %}{{ loan_status.status }}{% endif %}
          </span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Keperluan:</span>
          <span class="font-semibold text-slate-900">{{ pinjaman.keperluan }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Tenor:</span>
          <span class="font-semibold text-slate-900">{{ pinjaman.tenor }} Bulan</span>
        </div>
      </div>
    </div>

    <!-- Card 2: Detail Angsuran -->
    <div class="rounded-2xl bg-white/90 backdrop-blur border border-white/30 shadow-lg p-6">
      <h3 class="text-sm uppercase font-bold text-slate-600 mb-3">Detail Angsuran</h3>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Jumlah Pinjaman:</span>
          <span class="font-semibold text-slate-900">Rp{{ "{:,}".format(pinjaman.jumlah) }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Total Bunga:</span>
          <span class="font-semibold text-red-600">Rp{{ "{:,}".format(pinjaman.total_bunga|int) }}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-t-2 border-b-2 border-slate-300">
          <span class="text-slate-700 font-bold">Total Bayar:</span>
          <span class="font-bold text-slate-900 text-lg">Rp{{ "{:,}".format(pinjaman.total_bayar|int) }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-slate-700">Cicilan/Bulan:</span>
          <span class="font-semibold text-slate-900">Rp{{ "{:,}".format(pinjaman.angsuran|int) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS PEMBAYARAN -->
  <div class="rounded-2xl bg-white/90 backdrop-blur border border-white/30 shadow-lg p-6 mb-6">
    <h3 class="text-sm uppercase font-bold text-slate-600 mb-4">Progress Pembayaran</h3>
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <span class="text-slate-700">Total Sudah Dibayar:</span>
        <span class="font-semibold text-green-600">Rp{{ "{:,}".format(total_verified|int) }}</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="text-slate-700">Sisa Pembayaran:</span>
        <span class="font-semibold text-orange-600">Rp{{ "{:,}".format(sisa|int) }}</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
        <div class="bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full transition-all" style="width: {{ (total_verified / pinjaman.total_bayar * 100)|int }}%"></div>
      </div>
      <div class="text-xs text-slate-600 text-right">
        {{ ((total_verified / pinjaman.total_bayar * 100)|int) }}% Selesai
      </div>
    </div>
  </div>

  <!-- FORM PEMBAYARAN -->
  {% if sisa > 0 %}
  <div class="rounded-2xl bg-white/90 backdrop-blur border border-white/30 shadow-lg p-6 mb-6">
    <h3 class="text-lg font-bold text-slate-900 mb-4">ğŸ’³ Input Pembayaran Baru</h3>
    <form action="{{ url_for('bayar_pinjaman', pinjaman_id=pinjaman.id) }}" method="POST" enctype="multipart/form-data" class="space-y-4">
      
      <!-- Jumlah Pembayaran -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Jumlah Pembayaran</label>
        <input type="number" name="jumlah" required min="1" max="{{ sisa|int }}" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" placeholder="Masukkan jumlah pembayaran">
        <p class="text-xs text-slate-600 mt-1">Maksimal: Rp{{ "{:,}".format(sisa|int) }}</p>
      </div>

      <!-- Metode Pembayaran -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Metode Pembayaran</label>
        <select name="metode" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition">
          <option value="transfer">ğŸ’³ Transfer Bank</option>
          <option value="ewallet">ğŸ“± E-Wallet</option>
          <option value="cash">ğŸ’° Cash</option>
        </select>
      </div>

      <!-- Bukti Pembayaran -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Bukti Pembayaran (Opsional)</label>
        <input type="file" name="bukti" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition" accept=".png,.jpg,.jpeg,.pdf">
        <p class="text-xs text-slate-600 mt-1">Format: PNG, JPG, JPEG, PDF (Maks 5MB)</p>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition shadow-md">
        âœ… Kirim Pembayaran
      </button>
    </form>
  </div>
  {% else %}
    <div class="rounded-2xl bg-indigo-100 border border-indigo-300 p-6 mb-6 text-center">
      <p class="text-indigo-800 font-semibold text-lg">ğŸ Pinjaman Anda sudah lunas!</p>
    </div>
  {% endif %}

  <!-- RIWAYAT PEMBAYARAN -->
  <div class="rounded-2xl bg-white/90 backdrop-blur border border-white/30 shadow-lg overflow-hidden">
    <div class="p-6 border-b border-slate-200">
      <h3 class="text-lg font-bold text-slate-900">ğŸ“‹ Riwayat Pembayaran</h3>
    </div>
    
    {% if payments %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-900/5 border-b border-slate-200">
            <tr>
              <th class="text-left px-6 py-3 font-bold text-slate-700">Tanggal</th>
              <th class="text-right px-6 py-3 font-bold text-slate-700">Jumlah</th>
              <th class="text-center px-6 py-3 font-bold text-slate-700">Metode</th>
              <th class="text-center px-6 py-3 font-bold text-slate-700">Status</th>
              <th class="text-center px-6 py-3 font-bold text-slate-700">Bukti</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            {% for payment in payments %}
            <tr class="hover:bg-slate-50 transition">
              <td class="px-6 py-3 text-slate-700">{{ payment.created_at.strftime('%d-%m-%Y %H:%M') }}</td>
              <td class="px-6 py-3 text-right font-semibold text-slate-900">Rp{{ "{:,}".format(payment.jumlah) }}</td>
              <td class="px-6 py-3 text-center text-slate-600">
                {% if payment.metode == "transfer" %}ğŸ’³ Transfer
                {% elif payment.metode == "ewallet" %}ğŸ“± E-Wallet
                {% elif payment.metode == "cash" %}ğŸ’° Cash
                {% else %}{{ payment.metode }}{% endif %}
              </td>
              <td class="px-6 py-3 text-center">
                {% if payment.status == "pending" %}
                  <span class="px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">â³ Pending</span>
                {% elif payment.status == "verified" %}
                  <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">âœ… Verified</span>
                {% elif payment.status == "rejected" %}
                  <span class="px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">âŒ Rejected</span>
                {% endif %}
              </td>
              <td class="px-6 py-3 text-center">
                {% if payment.bukti_path %}
                  <a href="{{ url_for('static', filename=payment.bukti_path) }}" target="_blank" class="text-indigo-600 hover:text-indigo-700 font-semibold">
                    ğŸ” Lihat
                  </a>
                {% else %}
                  <span class="text-slate-400 text-xs">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-12 text-center text-slate-600">
        <p>ğŸ“­ Belum ada riwayat pembayaran</p>
      </div>
    {% endif %}
  </div>
{% endblock %}
